name: Build and Deploy Java WAR

on:
  push:
    branches:
      - master  # Change to your branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Set up Java
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Build WAR with Maven
    - name: Build WAR
      run: mvn clean package -DskipTests

    # 4. Copy WAR to remote Tomcat
    - name: Deploy WAR to Tomcat
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.TOMCAT_HOST }}
        username: ${{ secrets.TOMCAT_USER }}
        key: ${{ secrets.TOMCAT_SSH_KEY }}
        port: ${{ secrets.TOMCAT_SSH_PORT }}
        source: "target/onlinebookstore.war"
        target: "/opt/tomcat/webapps/onlinebookstore.war"

    # 5. Restart Tomcat
    - name: Restart Tomcat
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.TOMCAT_HOST }}
        username: ${{ secrets.TOMCAT_USER }}
        key: ${{ secrets.TOMCAT_SSH_KEY }}
        port: ${{ secrets.TOMCAT_SSH_PORT }}
        script: |
          /opt/tomcat/bin/shutdown.sh || true
          sleep 5
          /opt/tomcat/bin/startup.sh
